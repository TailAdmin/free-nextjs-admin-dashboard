// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Vendor {
  id            Int      @id @default(autoincrement())
  name          String
  rfc           String?   @map("RFC")
  address       String?
  phone         String?
  email         String   @unique
  password      String
  user          String?   @map("user")
  ip_last_login String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastLogin     DateTime?
  products      Product[]
}

// ---------------------------------------------------------
// PRODUCTS & COMMERCE
// ---------------------------------------------------------

model Product {
  id          Int     @id @default(autoincrement())
  nombre      String  @db.VarChar(60)
  descripcion String  @db.VarChar(120)
  altura      Float?  @db.Real // float4
  largo       Float?  @db.Real // float4
  ancho       Float?  @db.Real // float4
  peso        Float?  @db.Real // float4
  precio      Decimal @db.Decimal(10, 2)
  categoria   String? @db.VarChar
  inventario  Int     @default(0)
  color       String  @db.VarChar(40)
  marca       String  @db.VarChar(60)
  slug        String  @db.VarChar(120)
  vendedor    String  @db.VarChar(80)
  estado      Boolean @default(true)
  vendidos    Int     @default(0)
  sku         String  @db.VarChar(60)
  idPerfil    Int?
  idVendedor Int?

  vendedorConnection   Vendor? @relation(fields: [idVendedor], references: [id])

  images              ProductImage[]
  favoritos           Favorito[]
  carrito             Carrito[]
  reviews             Review[]
  createdCoupons      CreatedCouponEntity[]
  pedidoProductos     PedidoProducto[]
  transactionContents TransactionContents[]

  

  @@map("productos")
}

model ProductImage {
  id        Int     @id @default(autoincrement())
  url       String  @db.Text
  orden     Int     @default(0)
  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_images")
}

model Carrito {
  id             Int     @id @default(autoincrement())
  cantidad       Int
  precio_unitario Decimal @db.Decimal(10, 2)
  activo         Boolean
  
  usuarioId      Int?
  usuario        Profile? @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  productoId     Int?
  producto       Product? @relation(fields: [productoId], references: [id], onDelete: Cascade)

  @@map("carrito")
}

model Favorito {
  id            Int      @id @default(autoincrement())
  fechaAgregado DateTime @default(now()) @map("fecha_agregado")
  
  usuarioId     Int?
  usuario       Profile? @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  productoId    Int?
  producto      Product? @relation(fields: [productoId], references: [id], onDelete: Cascade)

  @@map("favorito")
}

model Review {
  id        Int      @id @default(autoincrement())
  rating    Int      @default(5)
  comment   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  profileId Int
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  images    ReviewImage[]

  @@map("reviews")
}

model ReviewImage {
  id       Int    @id @default(autoincrement())
  url      String @db.Text
  orden    Int    @default(0)
  
  reviewId Int
  review   Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@map("review_images")
}

model CreatedCouponEntity {
  id         String  @id @default(uuid())
  product_id Int
  product    Product @relation(fields: [product_id], references: [id])

  @@map("created_coupons")
}

model GiftedCouponEntity {
  id      String @id @default(uuid())
  user_id Int
  user    User   @relation(fields: [user_id], references: [id])

  @@map("gifted_coupons")
}

// ---------------------------------------------------------
// USERS & PROFILES
// ---------------------------------------------------------

model User {
  id            Int                  @id @default(autoincrement())
  nombre        String
  correo        String               @unique
  contrasena    String?              @db.VarChar
  rol           String               @default("usuario") @db.VarChar
  giftedCoupons GiftedCouponEntity[]

  // Note: This entity seems distinct from 'CreateAccount' (usuarios table)
  // Check if you need to map this to "user" or another table name if not default.
}

model CreateAccount {
  id             Int       @id @default(autoincrement())
  nombre         String?   @db.VarChar
  apellido       String?   @db.VarChar
  correo         String    @db.VarChar
  password       String?   @map("contrasena") @db.VarChar
  confirmado     Boolean   @default(false)
  token          String?   @db.VarChar
  tokenCreatedAt DateTime? @default(now()) @map("token_created_at") @db.Timestamp
  rol            String    @default("usuario") @db.VarChar

  profileId Int?     @unique
  profile   Profile? @relation(fields: [profileId], references: [id])

  @@map("usuarios")
}

model Profile {
  id               Int     @id @default(autoincrement())
  nombre           String  @db.VarChar(30)
  apellido         String  @db.VarChar(30)
  numero           String? @db.VarChar(10)
  estado           String  @db.VarChar
  ciudad           String  @db.VarChar
  fraccionamiento  String  @db.VarChar
  calle            String  @db.VarChar
  codigoPostal     String  @db.VarChar(5)
  imagen           String  @default("https://res.cloudinary.com/dgpd2ljyh/image/upload/v1748920792/default_nlbjlp.jpg") @db.Text
  stripeCustomerId String? @db.VarChar

  usuario CreateAccount?

  facturas     Factura[]
  transactions Transaction[]
  favoritos    Favorito[]
  carrito      Carrito[]
  direcciones  Misdireccione[]
  cards        Card[]
  reviews      Review[]
  pedidos      Pedido[]

  // Note: CreateAccount has OneToOne with Profile. 
  // In TypeORM it was defined on CreateAccount side with JoinColumn.
}

model Misdireccione {
  id                      Int     @id @default(autoincrement())
  nombre                  String  @db.VarChar(100)
  calle                   String  @db.VarChar(100)
  colonia_fraccionamiento String  @db.VarChar(100)
  numero_interior         Int?
  numero_exterior         Int?
  numero_celular          String  @db.VarChar(100)
  codigo_postal           String  @db.VarChar(5)
  estado                  String  @db.VarChar(50)
  municipio               String  @db.VarChar(100)
  mas_info                String? @db.VarChar(100)

  usuario_id Int?
  usuario    Profile? @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  pedidos Pedido[]

  @@map("misdireccione") // TypeORM default might be singular or plural, check DB. Assuming singular based on class name if not specified.
}

model Card {
  id           Int     @id @default(autoincrement())
  stripeCardId String
  last4        String
  brand        String
  profileId    Int
  profile      Profile @relation(fields: [profileId], references: [id])
}

// ---------------------------------------------------------
// ORDERS & TRANSACTIONS
// ---------------------------------------------------------

model Pedido {
  id              Int      @id @default(autoincrement())
  total           Decimal  @db.Decimal
  status          String
  fecha           DateTime @default(now()) @db.Timestamp(6)
  
  profileId       Int
  profile         Profile  @relation(fields: [profileId], references: [id])
  
  direccionId     Int?
  direccion       Misdireccione? @relation(fields: [direccionId], references: [id])

  estatus_pago    String?
  calle           String?
  numero_int      String?
  numero_exterior String?
  cp              String?
  ciudad          String?
  nombre          String?
  last4           String?
  brand           String?

  productos       PedidoProducto[]
}

model PedidoProducto {
  id         Int     @id @default(autoincrement())
  cantidad   Int
  n_guia     String?
  
  productoId Int
  producto   Product @relation(fields: [productoId], references: [id])
  
  pedidoId   Int
  pedido     Pedido  @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
}

model Transaction {
  id             Int      @id @default(autoincrement())
  total          Decimal  @db.Decimal
  diaTransaccion DateTime @default(now()) @db.Timestamp(6)
  
  profileId      Int
  profile        Profile  @relation(fields: [profileId], references: [id])
  
  contenidos     TransactionContents[]
}

model TransactionContents {
  id            Int         @id @default(autoincrement())
  precio        Decimal     @db.Decimal
  cantidad      Int
  
  productoId    Int?
  producto      Product?    @relation(fields: [productoId], references: [id])
  
  transactionId Int?
  transaction   Transaction? @relation(fields: [transactionId], references: [id], onDelete: Cascade)
}

model Factura {
  id                Int      @id @default(autoincrement())
  numero_factura    String   @unique
  precio            Decimal  @default(0.00) @db.Decimal(10, 2)
  sucursal          String
  status            String
  productos         String   @map("productos") // simple-array in TypeORM is usually comma-separated string
  fecha_creacion    DateTime @default(dbgenerated("CURRENT_DATE")) @db.Date
  fecha_vencimiento DateTime @db.Date
  
  profileId         Int?
  profile           Profile? @relation(fields: [profileId], references: [id])

  @@map("facturas")
}

// ---------------------------------------------------------
// VENDORS & PROVIDERS
// ---------------------------------------------------------

model Solicitud {
  id               Int     @id @default(autoincrement())
  nombre_tienda    String
  categoria_tienda String
  telefono         String
  email            String?
  direccion_fiscal String
  rfc              String
  curp             String
  img_uri          String?
  userId           Int

  @@map("solicitud_vendedor")
}

model Proveedor {
  id              Int     @id @default(autoincrement())
  proveedor       String
  sub             String
  id_usuario      Int
  correo_asociado String?

  @@map("proveedores")
}

// ---------------------------------------------------------
// LOGISTICS & SHIPPING
// ---------------------------------------------------------

model Unidad {
  id                 String   @id @default(uuid())
  tipo_vehiculo      Int
  tipoVehiculoRel    TipoVehiculo @relation(fields: [tipo_vehiculo], references: [id])
  placas             String   @unique
  volumen_carga      Decimal  @db.Decimal(10, 2)
  num_ejes           Int
  num_llantas        Int
  fecha_alta         DateTime @db.Timestamp
  tarjeta_circulacion String  @unique
  
  curp_conductor     String?
  conductor          Conductor? @relation(fields: [curp_conductor], references: [curp])
  
  clave_oficina      String   @db.VarChar(5)
  oficina            Oficina  @relation("UnidadOficina", fields: [clave_oficina], references: [clave_cuo])
  
  zona_asignada      String?  @db.VarChar(5)
  oficinaAsignada    Oficina? @relation("UnidadAsignada", fields: [zona_asignada], references: [clave_cuo])
  
  estado             String   @default("disponible") // Enum: disponible, no disponible

  envios             Envio[]

  @@map("unidades")
}

model TipoVehiculo {
  id           Int     @id @default(autoincrement())
  tipo_vehiculo String  @unique
  capacidad_kg Decimal @db.Decimal(10, 2)

  unidades            Unidad[]
  tipoVehiculoOficinas TipoVehiculoOficina[]

  @@map("tipos_vehiculos")
}

model TipoVehiculoOficina {
  id             Int          @id @default(autoincrement())
  tipo_vehiculo  Int
  tipoVehiculoRel TipoVehiculo @relation(fields: [tipo_vehiculo], references: [id])
  tipo_oficina   String

  @@map("tipo_vehiculo_sucursal")
}

model Conductor {
  id              Int      @id @default(autoincrement())
  nombre_completo String
  curp            String   @unique
  rfc             String   @unique
  licencia        String
  licencia_vigente Boolean
  telefono        String
  correo          String
  fecha_alta      DateTime @db.Timestamp
  
  clave_oficina   String   @db.VarChar(5)
  oficina         Oficina  @relation(fields: [clave_oficina], references: [clave_cuo])
  
  disponibilidad  Boolean

  unidades        Unidad[]

  @@map("conductores")
}

model Oficina {
  id_oficina           Int      @id @default(autoincrement())
  clave_oficina_postal String   @db.VarChar(5)
  clave_cuo            String   @unique @db.VarChar(5)
  clave_inmueble       String   @db.VarChar(5)
  clave_inegi          String   @db.VarChar(10)
  clave_entidad        String   @db.VarChar(2)
  nombre_entidad       String   @db.VarChar(50)
  nombre_municipio     String   @db.VarChar(50)
  tipo_cuo             String   // Enum
  nombre_cuo           String   @db.VarChar(100)
  domicilio            String   @db.VarChar(200)
  codigo_postal        String   @db.VarChar(5)
  clave_unica_zona     String?  @db.Text
  telefono             String   @db.VarChar(20)
  pais                 String   @default("MÃ©xico") @db.VarChar(50)
  latitud              Decimal  @db.Decimal
  longitud             Decimal  @db.Decimal
  activo               Boolean  @default(true)
  horario_atencion     String?  @db.VarChar(150)
  fecha_registro       DateTime @default(now()) @db.Timestamp

  unidades             Unidad[] @relation("UnidadOficina")
  unidadesAsignadas    Unidad[] @relation("UnidadAsignada")
  conductores          Conductor[]

  @@map("oficinas")
}

model HistorialAsignacion {
  id                  Int       @id @default(autoincrement())
  nombre_conductor    String    @db.VarChar(255)
  curp                String    @db.VarChar(18)
  placas_unidad       String    @db.VarChar(20)
  oficina_salida      String    @db.VarChar(5)
  clave_cuo_destino   String    @db.VarChar(10)
  clave_oficina_actual String?  @db.VarChar(10)
  fecha_asignacion    DateTime  @default(now()) @db.Timestamp
  fecha_llegada_destino DateTime? @db.Timestamp
  fecha_finalizacion  DateTime? @db.Timestamp

  @@map("asignaciones_historial")
}

model Envio {
  id                       String    @id @default(uuid())
  id_guia                  String    @db.Uuid
  guia                     Guia      @relation(fields: [id_guia], references: [id_guia], onDelete: Cascade)
  
  id_unidad                String?
  unidad                   Unidad?   @relation(fields: [id_unidad], references: [id], onDelete: SetNull)
  
  estado_envio             String    @default("pendiente") // Enum
  fecha_asignacion         DateTime  @default(now()) @db.Timestamp
  fecha_entrega_programada DateTime  @db.Date
  nombre_receptor          String?
  evidencia_entrega        String?
  motivo_fallo             String?
  fecha_entregado          DateTime? @db.Date
  fecha_fallido            DateTime? @db.Date

  @@map("envios")
}

model Guia {
  id_guia                String   @id @db.Uuid
  numero_de_rastreo      String   @unique
  situacion_actual       String
  
  id_remitente           String?  @db.Uuid
  remitente              ContactoGuia? @relation("Remitente", fields: [id_remitente], references: [id_contacto])
  
  id_destinatario        String?  @db.Uuid
  destinatario           ContactoGuia? @relation("Destinatario", fields: [id_destinatario], references: [id_contacto])
  
  alto_cm                Decimal  @db.Decimal(5, 2)
  largo_cm               Decimal  @db.Decimal(5, 2)
  ancho_cm               Decimal  @db.Decimal(5, 2)
  peso_kg                Decimal  @db.Decimal(4, 2)
  valor_declarado        Decimal  @db.Decimal(10, 2)
  fecha_creacion         DateTime @db.Timestamptz
  fecha_actualizacion    DateTime @db.Timestamptz
  fecha_entrega_estimada DateTime? @db.Timestamptz
  key_pdf                String?

  envios                 Envio[]

  @@map("guias")
}

model ContactoGuia {
  id_contacto     String  @id @db.Uuid
  id_usuario      String?
  nombres         String
  apellidos       String
  telefono        String
  calle           String
  numero          String
  numero_interior String?
  asentamiento    String
  codigo_postal   String
  localidad       String
  estado          String
  pais            String?
  lat             Decimal?
  lng             Decimal?
  referencia      String? @db.Text

  guiasRemitente    Guia[] @relation("Remitente")
  guiasDestinatario Guia[] @relation("Destinatario")

  @@map("contactos_guias")
}

// ---------------------------------------------------------
// SHIPPING RATES & ZONES
// ---------------------------------------------------------

model ShippingRate {
  id         Int     @id @default(autoincrement())
  kg_min     Decimal @db.Decimal(5, 2)
  kg_max     Decimal @db.Decimal(5, 2)
  price      Decimal @db.Decimal(10, 2)
  
  zone_id    Int
  zone       Zone    @relation(fields: [zone_id], references: [id])
  
  service_id Int
  service    Service @relation(fields: [service_id], references: [id])

  @@map("shipping_rates")
}

model Service {
  id            Int            @id @default(autoincrement())
  service_name  String         @db.VarChar(100)
  shippingRates ShippingRate[]

  @@map("services")
}

model Zone {
  id            Int            @id @default(autoincrement())
  zone_name     String         @db.VarChar(50)
  min_distance  Int
  max_distance  Int?
  shippingRates ShippingRate[]

  @@map("zones")
}

model InternationalZone {
  id          Int                   @id @default(autoincrement())
  code        String                @unique
  description String
  tariffs     InternationalTariff[]
  countries   InternationalCountry[]

  @@map("international_zones")
}

model InternationalTariff {
  id                Int               @id @default(autoincrement())
  zone_id           Int
  zone              InternationalZone @relation(fields: [zone_id], references: [id])
  max_kg            Float?
  base_price        Float?
  iva_percent       Float?
  additional_per_kg Float?

  @@map("international_tariffs")
}

model InternationalCountry {
  id       Int               @id @default(autoincrement())
  name     String            @unique// schema.prisma
iso_code String? @db.VarChar(3)
zone_id Int?
zone InternationalZone? @relation(fields: [zone_id], references: [id])

@@map("international_countries")
}